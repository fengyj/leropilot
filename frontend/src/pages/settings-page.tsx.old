import { useState, useEffect, useRef, useCallback } from 'react';
import { useTranslation } from 'react-i18next';
import { camelCase } from 'lodash';
import {
  Save,
  RotateCcw,
  AlertCircle,
  CheckCircle2,
  Trash2,
  Plus,
  Sun,
  Moon,
  Monitor,
  XCircle,
  Loader2,
} from 'lucide-react';
import { Button } from '../components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/card';
import { ConfirmDialog } from '../components/ui/confirm-dialog';
import { cn } from '../utils/cn';
import { useTheme } from '../contexts/theme-context';
import { RepositoryStatusButton } from '../components/repository-status-button';
import { useGitValidation } from '../hooks/useGitValidation';

interface ToolSource {
  type: 'bundled' | 'custom';
  custom_path: string | null;
}

interface RepositorySource {
  id: string;
  name: string;
  url: string;
  is_default: boolean;
}

interface PyPIMirror {
  name: string;
  url: string;
  enabled: boolean; // Only one mirror can be enabled at a time
}

interface AppConfig {
  server: {
    port: number;
    host: string;
    auto_open_browser: boolean;
  };
  ui: {
    theme: 'system' | 'light' | 'dark';
    preferred_language: 'en' | 'zh';
  };
  paths: {
    data_dir: string;
    repos_dir: string | null;
    environments_dir: string | null;
    logs_dir: string | null;
    cache_dir: string | null;
  };
  tools: {
    git: ToolSource;
  };
  repositories: {
    lerobot_sources: RepositorySource[];
  };
  pypi: {
    mirrors: PyPIMirror[];
  };
  advanced: {
    installation_timeout: number;
    log_level: 'INFO' | 'DEBUG' | 'TRACE';
  };
}



export function SettingsPage() {
  const { t, i18n } = useTranslation();
  const { setTheme: setAppTheme } = useTheme();
  const [config, setConfig] = useState<AppConfig | null>(null);
  const [savedConfig, setSavedConfig] = useState<AppConfig | null>(null);
  const [hasEnvironments, setHasEnvironments] = useState(false);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [message, setMessage] = useState<{
    type: 'success' | 'error';
    text: string;
  } | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [bundledGitStatus, setBundledGitStatus] = useState<{
    installed: boolean;
    version?: string;
    path?: string;
    message?: string;
    error?: string;
  } | null>(null);
  const [confirmDialog, setConfirmDialog] = useState<{
    isOpen: boolean;
    title: string;
    message: string;
    onConfirm: () => void;
    variant?: 'danger' | 'default';
  } | null>(null);
  const [bundledGitDownloadProgress, setBundledGitDownloadProgress] = useState<{
    message: string;
    progress: number;
  } | null>(null);
  const [configPath, setConfigPath] = useState<string | null>(null);

  // Use Git validation hook
  const gitValidation = useGitValidation();

  // Store cleanup state in ref to avoid dependency issues
  const cleanupStateRef = useRef<{
    savedConfig: AppConfig | null;
    currentConfig: AppConfig | null;
  }>({ savedConfig: null, currentConfig: null });

  // Store stable references to avoid dependency issues in cleanup
  const setAppThemeRef = useRef(setAppTheme);
  // Remove i18nRef and use i18n directly

  // Update refs when dependencies change
  useEffect(() => {
    setAppThemeRef.current = setAppTheme;
    // Remove i18n ref update
  }, [setAppTheme]);

  const loadConfig = useCallback(
    async (signal?: AbortSignal) => {
      try {
        const response = await fetch('/api/app-config', { signal });
        if (!response.ok)
          throw new Error(`Failed to load config: ${response.statusText}`);
        const data = await response.json();
        setConfig(data);
        setConfigPath(data.paths.data_dir); // Set config path from config data
        setSavedConfig(data); // Store the saved config for comparison
      } catch (error) {
        // Ignore AbortError - this is expected when component unmounts
        if (error instanceof Error && error.name === 'AbortError') {
          return;
        }
        console.error('Error loading config:', error);
        setError(
          error instanceof Error ? error.message : 'Unknown error loading config',
        );
        setMessage({ type: 'error', text: t('settings.messages.saveError') });
      } finally {
        setLoading(false);
      }
    },
    [t],
  );

  const checkEnvironments = useCallback(async (signal?: AbortSignal) => {
    try {
      const response = await fetch('/api/environments/has-environments', { signal });
      if (!response.ok) throw new Error('Failed to check environments');
      const data = await response.json();
      setHasEnvironments(data.has_environments);
    } catch (error) {
      // Ignore AbortError - this is expected when component unmounts
      if (error instanceof Error && error.name === 'AbortError') {
        return;
      }
      console.error('Failed to check environments:', error);
    }
  }, []);

  useEffect(() => {
    const abortController = new AbortController();
    loadConfig(abortController.signal);
    checkEnvironments(abortController.signal);

    return () => {
      abortController.abort();
    };
  }, [loadConfig, checkEnvironments]);

  useEffect(() => {
    // Cleanup: revert theme and language on unmount if not saved
    return () => {
      const { savedConfig, currentConfig } = cleanupStateRef.current;
      if (savedConfig && currentConfig) {
        if (savedConfig.ui.theme !== currentConfig.ui.theme) {
          setAppThemeRef.current(savedConfig.ui.theme);
        }
        if (savedConfig.ui.preferred_language !== currentConfig.ui.preferred_language) {
          i18n.changeLanguage(savedConfig.ui.preferred_language);
        }
      }
    };
  }, [i18n]); // Only run cleanup on unmount

  // Update cleanup state ref when config or savedConfig changes
  useEffect(() => {
    cleanupStateRef.current = {
      savedConfig,
      currentConfig: config,
    };
  }, [savedConfig, config]);

  // Live preview: Apply theme changes immediately via ThemeProvider
  useEffect(() => {
    if (config?.ui.theme) {
      setAppThemeRef.current(config.ui.theme);
    }
  }, [config?.ui.theme]);

  // Live preview: Apply language changes immediately
  useEffect(() => {
    const targetLang = config?.ui.preferred_language;
    if (!targetLang || i18n.language === targetLang) return;

    i18n
      .changeLanguage(targetLang)
      .catch((error) => console.error('Failed to change language:', error));
  }, [config?.ui.preferred_language, i18n]);

  // Check bundled git status
  useEffect(() => {
    if (config?.tools.git.type !== 'bundled') {
      setBundledGitStatus(null);
      return;
    }

    const abortController = new AbortController();

    fetch('/api/tools/git/bundled/status', {
      signal: abortController.signal,
    })
      .then((res) => res.json())
      .then((data) => setBundledGitStatus(data))
      .catch((err) => {
        // Ignore AbortError - this is expected when component unmounts
        if (err.name === 'AbortError') {
          return;
        }
        console.error('Failed to check bundled git:', err);
      });

    return () => {
      abortController.abort();
    };
  }, [config?.tools.git.type]);

  // Validate custom Git path on page load
  useEffect(() => {
    if (config?.tools.git.type === 'custom' && config.tools.git.custom_path) {
      gitValidation.validate(config.tools.git.custom_path);
    } else {
      gitValidation.clear();
    }
  }, [config?.tools.git.type, config?.tools.git.custom_path]);

  const handleDownloadBundledGit = async () => {
    setBundledGitDownloadProgress({ message: 'Starting download...', progress: 0 });
    try {
      const eventSource = new EventSource('/api/tools/git/bundled/download');

      eventSource.onmessage = (event) => {
        if (event.data === 'DONE') {
          eventSource.close();
          setBundledGitDownloadProgress(null);
          // Refresh status
          fetch('/api/tools/git/bundled/status')
            .then((res) => res.json())
            .then((data) => setBundledGitStatus(data));
          // Reload config to reflect changes
          loadConfig();
          return;
        }

        if (event.data.startsWith('ERROR:')) {
          eventSource.close();
          setBundledGitDownloadProgress(null);
          setMessage({ type: 'error', text: event.data.substring(7) });
          return;
        }

        try {
          const data = JSON.parse(event.data);
          setBundledGitDownloadProgress(data);
        } catch (e) {
          console.error('Failed to parse progress:', e);
        }
      };

      eventSource.onerror = () => {
        eventSource.close();
        setBundledGitDownloadProgress(null);
        setMessage({ type: 'error', text: 'Connection lost during download' });
      };
    } catch (err) {
      console.error('Failed to start download:', err);
      setBundledGitDownloadProgress(null);
      setMessage({ type: 'error', text: 'Failed to start download' });
    }
  };

  // Helper to check if a specific section has unsaved changes
  const hasUnsavedChanges = (section: 'theme' | 'language') => {
    if (!config || !savedConfig) return false;
    if (section === 'theme') {
      return config.ui.theme !== savedConfig.ui.theme;
    }
    if (section === 'language') {
      return config.ui.preferred_language !== savedConfig.ui.preferred_language;
    }
    return false;
  };

  const saveConfig = async () => {
    if (!config) return;

    setSaving(true);
    setMessage(null);

    try {
      const response = await fetch('/api/app-config', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Failed to save config');
      }

      // Update saved config after successful save
      setSavedConfig(config);

      setMessage({ type: 'success', text: t('settings.messages.saveSuccess') });

      // Language is already applied via live preview, no need to change again

      // Reload to get updated config
      await loadConfig();
      await checkEnvironments();
    } catch (error) {
      setMessage({
        type: 'error',
        text: error instanceof Error ? error.message : t('settings.messages.saveError'),
      });
    } finally {
      setSaving(false);
    }
  };

  const resetConfig = async () => {
    if (!confirm(t('settings.messages.resetConfirm'))) return;

    setSaving(true);
    setMessage(null);

    try {
      const response = await fetch('/api/app-config/reset', { method: 'POST' });
      if (!response.ok) throw new Error('Failed to reset config');
      const data = await response.json();
      setConfig(data);
      setConfigPath(data.paths.data_dir); // Set config path from reset config data
      setMessage({ type: 'success', text: t('settings.messages.saveSuccess') });
    } catch {
      setMessage({ type: 'error', text: t('settings.messages.saveError') });
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <div className="flex h-64 items-center justify-center">
        <div className="text-content-tertiary">Loading settings...</div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="flex h-64 flex-col items-center justify-center gap-4">
        <div className="text-error-icon">Error loading settings: {error}</div>
        <Button onClick={() => loadConfig()}>Retry</Button>
      </div>
    );
  }

  if (!config) {
    return (
      <div className="flex h-64 items-center justify-center">
        <div className="text-content-tertiary">No configuration loaded.</div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <h1 className="text-content-primary text-2xl font-bold tracking-tight">
          {t('settings.title')}
        </h1>
        <p className="text-content-secondary">{t('settings.subtitle')}</p>
      </div>

      {/* Message */}
      {message && (
        <div
          className={cn(
            'flex items-center gap-3 rounded-lg border p-4',
            message.type === 'success'
              ? 'border-success-border bg-success-surface text-success-content'
              : 'border-error-border bg-error-surface text-error-content',
          )}
        >
          {message.type === 'success' ? (
            <CheckCircle2 className="text-success-icon h-5 w-5" />
          ) : (
            <AlertCircle className="text-error-icon h-5 w-5" />
          )}
          <span>{message.text}</span>
        </div>
      )}

      {/* Appearance */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div className="space-y-1.5">
              <CardTitle>{t('settings.appearance.title')}</CardTitle>
              <p className="text-content-secondary text-sm">
                {t('settings.appearance.description')}
              </p>
            </div>
            {hasUnsavedChanges('theme') && (
              <span className="rounded border border-amber-900/50 bg-amber-900/20 px-2 py-1 text-xs font-medium text-amber-500">
                {t('settings.unsavedChanges')}
              </span>
            )}
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <label className="text-content-primary text-sm font-medium">
              {t('settings.appearance.theme')}
            </label>
            <p className="text-content-secondary mb-3 text-xs">
              {t('settings.appearance.themeDescription')}
            </p>
            <div className="grid grid-cols-3 gap-3">
              {(['system', 'light', 'dark'] as const).map((theme) => {
                const Icon =
                  theme === 'system' ? Monitor : theme === 'light' ? Sun : Moon;
                return (
                  <button
                    key={theme}
                    onClick={() =>
                      setConfig({ ...config, ui: { ...config.ui, theme } })
                    }
                    className={cn(
                      'flex flex-col items-center gap-2 rounded-lg border p-4 transition-all',
                      config.ui.theme === theme
                        ? 'border-blue-600 bg-blue-600/10 text-blue-500'
                        : 'border-border-default bg-surface-tertiary text-content-secondary hover:border-border-subtle',
                    )}
                  >
                    <Icon className="h-5 w-5" />
                    <span className="text-sm font-medium">
                      {t(`settings.appearance.${theme}`)}
                    </span>
                  </button>
                );
              })}
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Language */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div className="space-y-1.5">
              <CardTitle>{t('settings.language.title')}</CardTitle>
              <p className="text-content-secondary text-sm">
                {t('settings.language.description')}
              </p>
            </div>
            {hasUnsavedChanges('language') && (
              <span className="rounded border border-amber-900/50 bg-amber-900/20 px-2 py-1 text-xs font-medium text-amber-500">
                {t('settings.unsavedChanges')}
              </span>
            )}
          </div>
        </CardHeader>
        <CardContent>
          <div>
            <label className="text-content-primary text-sm font-medium">
              {t('settings.language.preferredLanguage')}
            </label>
            <select
              className="border-border-default bg-surface-secondary text-content-primary mt-2 w-full rounded-md border px-3 py-2 focus:border-blue-500 focus:outline-none"
              value={config.ui.preferred_language}
              onChange={(e) => {
                setConfig({
                  ...config,
                  ui: {
                    ...config.ui,
                    preferred_language: e.target.value as 'en' | 'zh',
                  },
                });
              }}
            >
              <option value="en">English</option>
              <option value="zh">中文</option>
            </select>
          </div>
        </CardContent>
      </Card>

      {/* Paths */}
      <Card>
        <CardHeader>
          <div className="space-y-1.5">
            <CardTitle>{t('settings.paths.title')}</CardTitle>
            <p className="text-content-secondary text-sm">
              {t('settings.paths.description')}
            </p>
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          {/* Paths Section */}
          {/* Paths Section */}
          <section className="space-y-4">
            <div className="space-y-4">
              {/* Data Dir */}
              <div className="space-y-2">
                <label className="text-content-secondary text-sm font-medium">
                  {t('settings.paths.dataDir')}
                </label>
                <div className="space-y-1">
                  <input
                    type="text"
                    className="border-border-default bg-surface-secondary text-content-primary w-full rounded-md border px-3 py-2 text-sm focus:border-blue-500 focus:outline-none"
                    value={config.paths.data_dir}
                    onChange={(e) =>
                      setConfig({
                        ...config,
                        paths: { ...config.paths, data_dir: e.target.value },
                      })
                    }
                    disabled={hasEnvironments}
                  />
                  <p className="text-content-tertiary text-xs">
                    {t('settings.paths.dataDirDescription')}
                  </p>
                  {hasEnvironments && (
                    <p className="text-warning-content text-xs">
                      {t('settings.paths.dataDirLocked')}
                    </p>
                  )}
                </div>
              </div>

              {/* Read-only Paths */}
              {(
                ['repos_dir', 'environments_dir', 'logs_dir', 'cache_dir'] as const
              ).map((pathKey) => (
                <div key={pathKey} className="space-y-2">
                  <label className="text-content-secondary text-sm font-medium">
                    {t(`settings.paths.${camelCase(pathKey)}` as string)}
                  </label>
                  <input
                    type="text"
                    className="border-border-default bg-surface-tertiary text-content-secondary w-full cursor-not-allowed rounded-md border px-3 py-2 text-sm focus:outline-none"
                    value={config.paths[pathKey] || ''}
                    readOnly
                  />
                </div>
              ))}

              <div className="bg-surface-secondary rounded-md p-3">
                <p className="text-content-secondary text-xs">
                  {t('settings.paths.configLocation')}{' '}
                  <span className="font-mono">{configPath}</span>
                </p>
              </div>
            </div>
          </section>
        </CardContent>
      </Card>

      {/* Tools */}
      <Card>
        <CardHeader>
          <div className="space-y-1.5">
            <CardTitle>{t('settings.tools.title')}</CardTitle>
            <p className="text-content-secondary text-sm">
              {t('settings.tools.description')}
            </p>
          </div>
        </CardHeader>
        <CardContent className="space-y-6">
          <div className="space-y-3">
            <label className="text-content-primary text-sm font-medium">
              {t('settings.tools.source')}
            </label>

            {/* Source selection */}
            <div className="flex gap-3">
              <button
                onClick={() =>
                  setConfig({
                    ...config,
                    tools: {
                      ...config.tools,
                      git: { ...config.tools.git, type: 'bundled' },
                    },
                  })
                }
                className={cn(
                  'flex-1 rounded-md border p-3 transition-all',
                  config.tools.git.type === 'bundled'
                    ? 'border-blue-600 bg-blue-600/10 text-blue-500'
                    : 'border-border-default bg-surface-tertiary text-content-secondary hover:border-border-subtle',
                )}
              >
                {t('settings.tools.bundled')}
              </button>
              <button
                onClick={() =>
                  setConfig({
                    ...config,
                    tools: {
                      ...config.tools,
                      git: { ...config.tools.git, type: 'custom' },
                    },
                  })
                }
                className={cn(
                  'flex-1 rounded-md border p-3 transition-all',
                  config.tools.git.type === 'custom'
                    ? 'border-blue-600 bg-blue-600/10 text-blue-500'
                    : 'border-border-default bg-surface-tertiary text-content-secondary hover:border-border-subtle',
                )}
              >
                {t('settings.tools.custom')}
              </button>
            </div>

            {/* Bundled Git Status */}
            {config.tools.git.type === 'bundled' && (
              <div className="space-y-2">
                <div className="relative">
                  <input
                    type="text"
                    readOnly
                    className={cn(
                      'border-border-default bg-surface-secondary text-content-primary w-full rounded-md border px-3 py-2 pr-10 focus:outline-none',
                      bundledGitStatus?.installed
                        ? 'border-green-500'
                        : 'border-amber-500',
                    )}
                    value={
                      bundledGitStatus?.installed
                        ? bundledGitStatus.path ||
                          bundledGitStatus.version ||
                          t('settings.tools.bundledInstalled')
                        : t('settings.tools.notInstalled')
                    }
                  />
                  {/* Status Icon */}
                  <div className="absolute top-1/2 right-3 -translate-y-1/2">
                    {bundledGitStatus?.installed ? (
                      <CheckCircle2 className="h-4 w-4 text-green-500" />
                    ) : (
                      <AlertCircle className="h-4 w-4 text-amber-500" />
                    )}
                  </div>
                </div>

                {/* Download Button */}
                {!bundledGitStatus?.installed && (
                  <button
                    type="button"
                    onClick={handleDownloadBundledGit}
                    disabled={!!bundledGitDownloadProgress}
                    className="mt-2 flex items-center gap-2 text-sm text-blue-500 hover:underline disabled:opacity-50"
                  >
                    {bundledGitDownloadProgress ? (
                      <>
                        <Loader2 className="h-3 w-3 animate-spin" />
                        {bundledGitDownloadProgress.message}
                      </>
                    ) : (
                      t('settings.tools.downloadAndInstall')
                    )}
                  </button>
                )}

                {/* Error Message */}
                {bundledGitStatus?.error && (
                  <p className="text-error-content mt-1 text-xs">
                    {bundledGitStatus.error}
                  </p>
                )}
              </div>
            )}

            {/* Custom path input */}
            {config.tools.git.type === 'custom' && (
              <div className="space-y-2">
                <div className="relative">
                  <input
                    type="text"
                    placeholder={t('settings.tools.gitPathPlaceholder')}
                    className={cn(
                      'border-border-default bg-surface-secondary text-content-primary w-full rounded-md border px-3 py-2 pr-10 focus:border-blue-500 focus:outline-none',
                      gitValidation.error && 'border-error-border focus:border-error-border',
                      !gitValidation.error &&
                        gitValidation.validation &&
                        'border-green-500',
                    )}
                    value={config.tools.git.custom_path || ''}
                    onChange={(e) => {
                      setConfig({
                        ...config,
                        tools: {
                          ...config.tools,
                          git: { ...config.tools.git, custom_path: e.target.value },
                        },
                      });
                      // Clear validation state when user types
                      gitValidation.clear();
                    }}
                    onBlur={(e) => {
                      const path = e.target.value;
                      if (path) {
                        gitValidation.validate(path);
                      }
                    }}
                  />
                  {/* Validation icon */}
                  <div className="absolute top-1/2 right-3 -translate-y-1/2">
                    {gitValidation.isValidating ? (
                      <Loader2 className="h-4 w-4 animate-spin text-gray-400" />
                    ) : gitValidation.error ? (
                      <div className="group relative">
                        <XCircle className="h-4 w-4 text-red-500" />
                        <div className="absolute top-6 right-0 z-10 hidden w-64 rounded-md bg-gray-900 px-3 py-2 text-xs text-white shadow-lg group-hover:block">
                          {gitValidation.error}
                        </div>
                      </div>
                    ) : gitValidation.validation ? (
                      <div className="group relative">
                        <CheckCircle2 className="h-4 w-4 text-green-500" />
                        <div className="absolute top-6 right-0 z-10 hidden rounded-md bg-gray-900 px-3 py-2 text-xs whitespace-nowrap text-white shadow-lg group-hover:block">
                          {gitValidation.validation}
                        </div>
                      </div>
                    ) : null}
                  </div>
                </div>
                {/* Auto-detect button */}
                {!config.tools.git.custom_path && (
                  <button
                    type="button"
                    onClick={async () => {
                      // Validate 'git' command first
                      await gitValidation.validate('git');

                      // If valid, get the actual path
                      if (!gitValidation.error) {
                        try {
                          const whichResponse = await fetch('/api/tools/git/which');
                          const whichData = await whichResponse.json();
                          if (whichData.path) {
                            setConfig({
                              ...config,
                              tools: {
                                ...config.tools,
                                git: {
                                  ...config.tools.git,
                                  custom_path: whichData.path,
                                },
                              },
                            });
                          }
                        } catch (err) {
                          console.error('Failed to get git path:', err);
                        }
                      }
                    }}
                    disabled={gitValidation.isValidating}
                    className="mt-2 flex items-center gap-2 text-sm text-blue-500 hover:underline disabled:opacity-50"
                  >
                    {t('settings.tools.autoDetect')}
                  </button>
                )}
              </div>
            )}
          </div>
        </CardContent>
      </Card>

      {/* LeRobot Repositories */}
      <Card>
        <CardHeader>
          <div className="space-y-1.5">
            <CardTitle>{t('settings.repositories.title')}</CardTitle>
            <p className="text-content-secondary text-sm">
              {t('settings.repositories.description')}
            </p>
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="space-y-2">
            {config.repositories.lerobot_sources.map((source, index) => (
              <div
                key={index}
                className="group border-border-default bg-surface-tertiary rounded-md border p-3"
              >
                {/* Name input */}
                <input
                  type="text"
                  placeholder={t('settings.repositories.name')}
                  className="border-border-default bg-surface-secondary text-content-primary mb-2 w-full rounded-md border px-3 py-2 focus:border-blue-500 focus:outline-none disabled:opacity-50"
                  value={source.name}
                  onChange={(e) => {
                    const newSources = [...config.repositories.lerobot_sources];
                    newSources[index] = { ...source, name: e.target.value };
                    setConfig({
                      ...config,
                      repositories: {
                        ...config.repositories,
                        lerobot_sources: newSources,
                      },
                    });
                  }}
                  disabled={source.is_default}
                />

                {/* URL input */}
                <input
                  type="text"
                  placeholder={t('settings.repositories.url')}
                  className="border-border-default bg-surface-secondary text-content-primary mb-2 w-full rounded-md border px-3 py-2 focus:border-blue-500 focus:outline-none disabled:opacity-50"
                  value={source.url}
                  onChange={(e) => {
                    const newSources = [...config.repositories.lerobot_sources];
                    newSources[index] = { ...source, url: e.target.value };
                    setConfig({
                      ...config,
                      repositories: {
                        ...config.repositories,
                        lerobot_sources: newSources,
                      },
                    });
                  }}
                  disabled={source.is_default}
                />

                {/* All action buttons, badges, and status in one row below URL */}
                <div className="flex items-center justify-between gap-2">
                  {/* Left side: Default badge and action buttons */}
                  <div className="flex items-center gap-2">
                    {/* Default badge - only show if is_default */}
                    {source.is_default && (
                      <span className="inline-flex items-center rounded-full bg-blue-50 px-2 py-1 text-xs font-medium text-blue-700 ring-1 ring-blue-700/10 ring-inset dark:bg-blue-400/10 dark:text-blue-400 dark:ring-blue-400/30">
                        {t('settings.repositories.default')}
                      </span>
                    )}

                    {/* Set as default button - only show if not default and repo is saved */}
                    {!source.is_default &&
                      savedConfig?.repositories.lerobot_sources.some(
                        (s) => s.id === source.id,
                      ) &&
                      source.url && (
                        <button
                          onClick={() => {
                            const newSources = config.repositories.lerobot_sources.map(
                              (s, i) => ({
                                ...s,
                                is_default: i === index,
                              }),
                            );
                            setConfig({
                              ...config,
                              repositories: {
                                ...config.repositories,
                                lerobot_sources: newSources,
                              },
                            });
                          }}
                          className="border-border-default bg-surface-tertiary text-content-secondary hover:bg-surface-secondary hover:text-content-primary h-9 rounded-md border p-2 text-xs"
                          title={t('settings.repositories.setAsDefault')}
                        >
                          {t('settings.repositories.setAsDefault')}
                        </button>
                      )}

                    {/* Delete button - only show if not default */}
                    {!source.is_default && (
                      <button
                        onClick={() => {
                          setConfirmDialog({
                            isOpen: true,
                            title: t('common.delete'),
                            message: t('settings.repositories.deleteConfirm', {
                              name: source.name,
                            }),
                            onConfirm: () => {
                              const newSources =
                                config.repositories.lerobot_sources.filter(
                                  (_, i) => i !== index,
                                );
                              setConfig({
                                ...config,
                                repositories: {
                                  ...config.repositories,
                                  lerobot_sources: newSources,
                                },
                              });
                              setConfirmDialog(null);
                            },
                            variant: 'danger',
                          });
                        }}
                        className="border-border-default bg-surface-tertiary text-error-icon hover:border-error-border hover:bg-error-surface h-9 rounded-md border p-2 opacity-0 transition-opacity group-hover:opacity-100"
                      >
                        <Trash2 className="h-4 w-4" />
                      </button>
                    )}
                  </div>

                  {/* Right side: Download/Update button */}
                  {savedConfig?.repositories.lerobot_sources.some(
                    (s) => s.id === source.id,
                  ) &&
                    source.url && (
                      <RepositoryStatusButton
                        repoId={source.id}
                        repoName={source.name}
                        variant="link"
                        size="sm"
                      />
                    )}
                </div>
              </div>
            ))}
          </div>
          <Button
            variant="secondary"
            onClick={() => {
              // Generate UUID for new repository
              const newId = crypto.randomUUID();
              const newSources = [
                ...config.repositories.lerobot_sources,
                { id: newId, name: 'Custom', url: '', is_default: false },
              ];
              setConfig({
                ...config,
                repositories: { ...config.repositories, lerobot_sources: newSources },
              });
            }}
          >
            <Plus className="mr-2 h-4 w-4" />
            {t('settings.repositories.addSource')}
          </Button>
        </CardContent>
      </Card>

      {/* PyPI Mirrors */}
      <Card>
        <CardHeader>
          <div className="space-y-1.5">
            <CardTitle>{t('settings.pypi.title')}</CardTitle>
            <p className="text-content-secondary text-sm">
              {t('settings.pypi.description')}
            </p>
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          {/* Current status */}
          <div className="rounded-md bg-blue-50 p-3 text-sm dark:bg-blue-900/20">
            <div className="font-medium text-blue-700 dark:text-blue-300">
              {config.pypi.mirrors.some((m) => m.enabled)
                ? `${t('settings.pypi.currentMirror')}: ${config.pypi.mirrors.find((m) => m.enabled)?.name}`
                : t('settings.pypi.usingOfficial')}
            </div>
          </div>

          {/* Mirror List */}
          <div className="space-y-2">
            {config.pypi.mirrors.map((mirror, index) => (
              <div
                key={index}
                className={cn(
                  'group border-border-default rounded-md border p-3 transition-all',
                  mirror.enabled
                    ? 'border-blue-200 bg-blue-50 dark:border-blue-800 dark:bg-blue-900/20'
                    : 'bg-surface-tertiary',
                )}
              >
                <input
                  type="text"
                  placeholder={t('settings.pypi.name')}
                  className="border-border-default bg-surface-secondary text-content-primary mb-2 w-full rounded-md border px-3 py-2 focus:border-blue-500 focus:outline-none"
                  value={mirror.name}
                  onChange={(e) => {
                    const newMirrors = [...config.pypi.mirrors];
                    newMirrors[index] = { ...mirror, name: e.target.value };
                    setConfig({
                      ...config,
                      pypi: { ...config.pypi, mirrors: newMirrors },
                    });
                  }}
                />
                <input
                  type="text"
                  placeholder={t('settings.pypi.url')}
                  className="border-border-default bg-surface-secondary text-content-primary mb-2 w-full rounded-md border px-3 py-2 focus:border-blue-500 focus:outline-none"
                  value={mirror.url}
                  onChange={(e) => {
                    const newMirrors = [...config.pypi.mirrors];
                    newMirrors[index] = { ...mirror, url: e.target.value };
                    setConfig({
                      ...config,
                      pypi: { ...config.pypi, mirrors: newMirrors },
                    });
                  }}
                />
                <div className="flex items-center gap-2">
                  {/* Enable/Disable button */}
                  {mirror.enabled ? (
                    <button
                      onClick={() => {
                        // Disable this mirror (return to official PyPI)
                        const newMirrors = [...config.pypi.mirrors];
                        newMirrors[index] = { ...mirror, enabled: false };
                        setConfig({
                          ...config,
                          pypi: { ...config.pypi, mirrors: newMirrors },
                        });
                      }}
                      className="rounded-md border border-blue-600 bg-blue-600 px-3 py-2 text-xs font-medium whitespace-nowrap text-white hover:bg-blue-700"
                    >
                      {t('settings.pypi.disable')}
                    </button>
                  ) : (
                    <button
                      onClick={() => {
                        // Enable this mirror, disable all others
                        const newMirrors = config.pypi.mirrors.map((m, i) => ({
                          ...m,
                          enabled: i === index,
                        }));
                        setConfig({
                          ...config,
                          pypi: { ...config.pypi, mirrors: newMirrors },
                        });
                      }}
                      className="border-border-default bg-surface-tertiary text-content-secondary hover:bg-surface-secondary hover:text-content-primary rounded-md border px-3 py-2 text-xs font-medium whitespace-nowrap"
                    >
                      {t('settings.pypi.enable')}
                    </button>
                  )}
                  {/* Delete button */}
                  <button
                    onClick={() => {
                      setConfirmDialog({
                        isOpen: true,
                        title: t('common.delete'),
                        message: t('settings.pypi.deleteConfirm', {
                          name: mirror.name,
                        }),
                        onConfirm: () => {
                          const newMirrors = config.pypi.mirrors.filter(
                            (_, i) => i !== index,
                          );
                          setConfig({
                            ...config,
                            pypi: { ...config.pypi, mirrors: newMirrors },
                          });
                          setConfirmDialog(null);
                        },
                        variant: 'danger',
                      });
                    }}
                    className="border-border-default bg-surface-tertiary text-error-icon hover:border-error-border hover:bg-error-surface rounded-md border p-2 opacity-0 transition-opacity group-hover:opacity-100"
                    title={t('settings.pypi.delete')}
                  >
                    <Trash2 className="h-4 w-4" />
                  </button>
                </div>
              </div>
            ))}
          </div>
          <Button
            variant="secondary"
            onClick={() => {
              const newMirrors = [
                ...config.pypi.mirrors,
                { name: 'Custom Mirror', url: '', enabled: false },
              ];
              setConfig({ ...config, pypi: { ...config.pypi, mirrors: newMirrors } });
            }}
          >
            <Plus className="mr-2 h-4 w-4" />
            {t('settings.pypi.addMirror')}
          </Button>
        </CardContent>
      </Card>

      {/* Advanced */}
      <Card>
        <CardHeader>
          <div className="space-y-1.5">
            <CardTitle>{t('settings.advanced.title')}</CardTitle>
            <p className="text-content-secondary text-sm">
              {t('settings.advanced.description')}
            </p>
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <label className="text-content-primary text-sm font-medium">
              {t('settings.advanced.installationTimeout')}
            </label>
            <p className="text-content-secondary mb-2 text-xs">
              {t('settings.advanced.installationTimeoutDescription')}
            </p>
            <input
              type="number"
              className="border-border-default bg-surface-secondary text-content-primary mt-2 w-full rounded-md border px-3 py-2 focus:border-blue-500 focus:outline-none"
              value={config.advanced.installation_timeout}
              onChange={(e) =>
                setConfig({
                  ...config,
                  advanced: {
                    ...config.advanced,
                    installation_timeout: parseInt(e.target.value),
                  },
                })
              }
            />
          </div>

          <div>
            <label className="text-content-primary text-sm font-medium">
              {t('settings.advanced.logLevel')}
            </label>
            <p className="text-content-secondary mb-2 text-xs">
              {t('settings.advanced.logLevelDescription')}
            </p>
            <select
              className="border-border-default bg-surface-secondary text-content-primary mt-2 w-full rounded-md border px-3 py-2 focus:border-blue-500 focus:outline-none"
              value={config.advanced.log_level}
              onChange={(e) =>
                setConfig({
                  ...config,
                  advanced: {
                    ...config.advanced,
                    log_level: e.target.value as 'INFO' | 'DEBUG' | 'TRACE',
                  },
                })
              }
            >
              <option value="INFO">{t('settings.advanced.logLevelInfo')}</option>
              <option value="DEBUG">{t('settings.advanced.logLevelDebug')}</option>
              <option value="TRACE">{t('settings.advanced.logLevelTrace')}</option>
            </select>
          </div>
        </CardContent>
      </Card>

      {/* Actions */}
      <div className="border-border-default flex justify-between border-t pt-6">
        <Button variant="ghost" onClick={resetConfig} disabled={saving}>
          <RotateCcw className="mr-2 h-4 w-4" />
          {t('settings.buttons.reset')}
        </Button>
        <Button onClick={saveConfig} disabled={saving}>
          <Save className="mr-2 h-4 w-4" />
          {saving ? 'Saving...' : t('settings.buttons.save')}
        </Button>
      </div>

      {/* Confirm Dialog */}
      <ConfirmDialog
        isOpen={confirmDialog?.isOpen || false}
        title={confirmDialog?.title || ''}
        message={confirmDialog?.message || ''}
        onConfirm={confirmDialog?.onConfirm || (() => {})}
        onCancel={() => setConfirmDialog(null)}
        variant={confirmDialog?.variant}
      />
    </div>
  );
}
